<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞–Ω–µ–ª—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –º–∞—è–∫–æ–≤</title>

    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            background-color: #2c3e50;
            color: white;
            padding: 15px 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .header h1 {
            margin: 0;
            font-size: 1.5em;
        }

        .status {
            font-size: 0.9em;
            color: #ecf0f1;
            margin-top: 5px;
        }

        #map {
            flex-grow: 1;
            width: 100%;
        }

        .custom-beacon-icon {
            background-color: #e74c3c;
            border: 3px solid #c0392b;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.7);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 10px rgba(231, 76, 60, 0.7); }
            50% { box-shadow: 0 0 20px rgba(231, 76, 60, 0.9); }
            100% { box-shadow: 0 0 10px rgba(231, 76, 60, 0.7); }
        }
    </style>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>üö® –ü–∞–Ω–µ–ª—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –º–∞—è–∫–æ–≤</h1>
            <div class="status" id="connection-status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...</div>
        </div>
        <div id="map"></div>
    </div>

    <script>
        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ö–ê–†–¢–´ ---
        const map = L.map('map').setView([55.7558, 37.6173], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '¬© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –ú–ê–†–ö–ï–†–ê–ú–ò –ú–ê–Ø–ö–û–í ---
        const beaconMarkers = {};

        function getBeaconIcon() {
            return L.divIcon({
                className: 'custom-beacon-icon',
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
        }

        /**
         * –û–±–Ω–æ–≤–ª—è–µ—Ç –∏–ª–∏ –ø–ª–∞–≤–Ω–æ –ø–µ—Ä–µ–º–µ—â–∞–µ—Ç –º–∞—Ä–∫–µ—Ä –º–∞—è–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–µ.
         * @param {object} beaconData - –î–∞–Ω–Ω—ã–µ –º–∞—è–∫–∞ { deviceId, lat, lng, lastSeen }
         */
        function updateBeacon(beaconData) {
            const { deviceId, lat, lng, lastSeen } = beaconData;
            const newPosition = L.latLng(lat, lng);

            const popupContent = `
                <b>–ú–∞—è–∫ ID:</b> <code>\${deviceId}</code><br>
                <b>–®–∏—Ä–æ—Ç–∞:</b> \${lat.toFixed(5)}<br>
                <b>–î–æ–ª–≥–æ—Ç–∞:</b> \${lng.toFixed(5)}<br>
                <b>–ü–æ—Å–ª–µ–¥–Ω–∏–π —Å–∏–≥–Ω–∞–ª:</b> \${new Date(lastSeen).toLocaleString()}
            `;

            if (beaconMarkers[deviceId]) {
                const marker = beaconMarkers[deviceId];

                // --- –ù–û–í–û–ï: –ü–ª–∞–≤–Ω–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞ ---
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é Leaflet –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
                marker.animateTo(newPosition, {
                    duration: 2000 // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö (2 —Å–µ–∫—É–Ω–¥—ã)
                });

                marker.setPopupContent(popupContent);
            } else {
                // –ï—Å–ª–∏ –º–∞—Ä–∫–µ—Ä–∞ –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ –≤ –Ω–∞—á–∞–ª—å–Ω–æ–π —Ç–æ—á–∫–µ
                const newMarker = L.marker(newPosition, { icon: getBeaconIcon() })
                    .addTo(map)
                    .bindPopup(popupContent);

                beaconMarkers[deviceId] = newMarker;
            }
        }

        // --- –†–ê–ë–û–¢–ê –° –°–ï–†–í–ï–†–û–ú (SOCKET.IO) ---
        const socket = io();
        const statusElement = document.getElementById('connection-status');

        socket.on('connect', () => {
            console.log('‚úÖ –£—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É.');
            statusElement.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ. –û–∂–∏–¥–∞–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–æ–≤ –º–∞—è–∫–æ–≤...';
            statusElement.style.color = '#2ecc71';
        });

        socket.on('disconnect', () => {
            console.log('‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ.');
            statusElement.textContent = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ. –ü—ã—Ç–∞—é—Å—å –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è...';
                        statusElement.style.color = '#e74c3c';
        });

        socket.on('beacon_update', (data) => {
            console.log('üìç –ü–æ–ª—É—á–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç –º–∞—è–∫–∞:', data.deviceId);
            updateBeacon(data);
        });

        // --- –ó–ê–ì–†–£–ó–ö–ê –ù–ê–ß–ê–õ–¨–ù–´–• –î–ê–ù–ù–´–• ---
        async function loadInitialBeacons() {
            try {
                statusElement.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–∞—è–∫–æ–≤...';
                const response = await fetch('/api/beacons');
                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ HTTP: ${response.status}`);
                }
                const beacons = await response.json();
                console.log(`üó∫Ô∏è –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${beacons.length} –º–∞—è–∫–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞.`);
                beacons.forEach(beacon => updateBeacon(beacon));
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:', error);
                statusElement.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–∞—è–∫–∏.';
                statusElement.style.color = '#e67e22';
            }
        }

        loadInitialBeacons();
    </script>

    <!-- –ù–û–í–û–ï: –ü–æ–¥–∫–ª—é—á–∞–µ–º –ø–ª–∞–≥–∏–Ω –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞ -->
    <script src="https://unpkg.com/leaflet.marker.slideto@0.2.0/Leaflet.Marker.SlideTo.js"></script>
</body>
</html>