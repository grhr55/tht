
<!DOCTYPE html>
<html>
<head>
    <title>GLOBAL RADAR - Net Control</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1a1a1a; color: #e0e0e0; }
        #map { height: 100vh; width: 100%; }
        .leaflet-popup-content-wrapper { background: #333; border: 1px solid #555; }
        .leaflet-popup-content { color: #e0e0e0; }
        .leaflet-popup-close-button { color: #e0e0e0 !important; }
        .device-info { font-size: 0.9em; }
        .device-id { font-weight: bold; color: #00cc00; }
        .device-key { color: #ffcc00; font-size: 1.1em; margin-top: 5px; display: block; }
        .device-model { font-style: italic; color: #999; margin-top: 3px; }
        .refresh-prompt { font-size: 0.8em; color: #aaa; margin-top: 10px; cursor: pointer; text-decoration: underline; }
    </style>
</head>
<body>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const map = L.map('map').setView([20, 0], 2); // Центрируем карту мира
        
        // Используем темную тему Leaflet
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://carto.com/basemaps/">CARTO</a> | &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
            subdomains: 'abcd',
            maxZoom: 20
        }).addTo(map);

        const markers = {};

        // Функция для обновления маркера на карте
        function addOrUpdateMarker(deviceId, model, lat, lng, key, isOld = false) {
            const label = `
                <div class="device-info">
                    <span class="device-id">ID: ${deviceId}</span><br>
                    <span class="device-model">Model: ${model || 'Unknown'}</span><br>
                    <span class="device-key">UNLOCK KEY: ${key}</span>
                    ${isOld ? `<div class="refresh-prompt" onclick="refreshKey('${deviceId}')">Refresh Key</div>` : ''}
                </div>
            `;
            

            if (markers[deviceId]) {
                // Обновляем существующий маркер
                markers[deviceId].setLatLng([lat, lng]);

                markers[deviceId].setPopupContent(label);
                // Обновляем цвет иконки, если это новый маркер
                if (!isOld) {
                    markers[deviceId].setIcon(L.icon({
                        iconUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png',
                        shadowSize: [41, 41],
                        shadowAnchor: [12, 41]
                    }));
                }
            } else {
                // Создаем новый маркер
                const marker = L.marker([lat, lng]).addTo(map).bindPopup(label);
                markers[deviceId] = marker;
                // Устанавливаем иконку для новых устройств (можно сделать разные иконки)
                if (!isOld) {
                    marker.setIcon(L.icon({
                        iconUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png', // Стандартная иконка
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png',
                        shadowSize: [41, 41],
                        shadowAnchor: [12, 41]
                    }));
                } else {
                    
                    marker.setIcon(L.icon({
                        iconUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon-grey.png', // Серый маркер для старых данных
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png',
                        shadowSize: [41, 41],
                        shadowAnchor: [12, 41]
                    }));
                }
            }
        }

        // Функция для запроса обновления ключа
        function refreshKey(deviceId) {
            fetch('/api/verify', { // Используем API verify для перезагенерации ключа (предполагаем, что оно это делает)
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ deviceId: deviceId, code: "FORCE_REFRESH" }) // Здесь может быть специальный код для сервера
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Если сервер подтвердил, что ключ обновлен (нужно доработать сервер)
                    // В данном примере, для простоты, просто обновляем маркер с новым ключом, который мы не знаем
                    // Реально сервер должен вернуть новый ключ
                    console.log("Key refresh requested for " + deviceId);
                    // Обновляем маркер с временным сообщением
                     markers[deviceId].setPopupContent(markers[deviceId].getPopup().getContent() + "<br><b>Key refresh initiated. Check server logs.</b>");
                } else {
                    console.error("Key refresh failed for " + deviceId, data.message);
                     markers[deviceId].setPopupContent(markers[deviceId].getPopup().getContent() + "<br><b>Key refresh failed.</b>");
                }
            })
            .catch(error => {
                console.error('Error refreshing key:', error);
                 markers[deviceId].setPopupContent(markers[deviceId].getPopup().getContent() + "<br><b>Network error during key refresh.</b>");

});
        }

        // Подключение к Socket.IO серверу
        const socket = io('http://'+window.location.hostname+':3000'); // Подключаемся к серверу на том же домене
        
        socket.on('update', d => {
            console.log('Received update:', d);
            addOrUpdateMarker(d.deviceId, d.model, d.lat, d.lng, d.key, false);
        });

        // Загружаем старые данные при старте
        fetch('/api/targets').then(r => r.ok ? r.json() : Promise.reject('Network response was not ok'))
            .then(data => {
                console.log('Loaded old targets:', data);
                data.forEach(t => addOrUpdateMarker(t.deviceId, t.model, t.lat, t.lng, t.key, true)); // isOld = true
            })
            .catch(error => console.error('Error fetching old targets:', error));

    </script>
</body>
</html>